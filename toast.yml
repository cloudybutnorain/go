image: golang:1.21
command_prefix: set -euxo pipefail
location: /scratch
tasks:
  deps:
    input_paths:
    - go.mod
    - go.sum
    command: |
      go mod download
  build:
    # I would like to cache this but go-build files prevent it
    cache: false
    dependencies:
    - deps
    environment:
      GOCACHE: /scratch/go-build
      CGO_ENABLED: 0
      GOOS: linux
    mount_paths:
    - go-build/
    input_paths:
    - client/
    - cmd/
    - util/
    - main.go
    output_paths:
    - out/cbnr
    command: |
      go build -o out/cbnr
  # test:
  #   cache: false
  #   dependencies:
  #   - build
  #   environment:
  #     GOCACHE: /scratch/go-build
  #     CGO_ENABLED: 0
  #     GOOS: linux
  #   mount_paths:
  #   - go-build/
  #   input_paths:
  #   - out/cbnr
  #   command: |
  #     go test
